package noot.compiler;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Stack;

import noot.assembly.Instruction;
import noot.assembly.InstructionBlock;
import noot.assembly.MemoryLocation;
import noot.ast.DeclarationNode;
import noot.ast.IdentifierNode;

public class GeneratorHelper {
	
	private ArrayList<MemoryLocation> memoryLocations = new ArrayList<MemoryLocation>();
	
	private Stack<InstructionBlock> instructionBlockStack = new Stack<InstructionBlock>();
	
	public GeneratorHelper()
	{	
		instructionBlockStack.push(new InstructionBlock(0));
	}

	public void pushBlock()
	{
		if(this.instructionBlockStack.peek().size() > 0)
		{
			instructionBlockStack.push(new InstructionBlock(currentBlock().labelIdentifier + 1));
		}
	}
	
	public void pushInstructionsForPrintingString(String s)
	{
		for (int i = 0; i < s.length(); i++)
		{
            char c = s.charAt(i);        
            currentBlock().push(new Instruction("LOADL",Integer.toString(c),"Loading character"));
            currentBlock().push(new Instruction("CALL","put","Print character"));
        }
	}
	
	public void finalizeAndPrintInstructions()
	{
		
		int pushCount = 0;
		for(InstructionBlock ib : instructionBlockStack)
		{
			for(Instruction in : ib)
			{
				if(in.getInstruction().equals("PUSH")) pushCount ++;
			}
		}
		
		currentBlock().push(new Instruction("POP",Integer.toString(pushCount),0));
		
		DateFormat dateFormat = new SimpleDateFormat("yyyy/MM/dd HH:mm");
		Date date = new Date();
		
		Instruction haltInstruction = new Instruction("HALT");
		haltInstruction.setComment("Generated by the Noot Compiler ("+dateFormat.format(date)+")");
		
		currentBlock().push(haltInstruction);
		
		pushBlock();
		
		
		for(InstructionBlock block : instructionBlockStack)
		{
			for(Instruction instruction : block)
				System.out.print(instruction.toString());
		}
	}
	
	public void declare(DeclarationNode declaration)
	{
		IdentifierNode in = declaration.getIdentifierNode();
		
		if(in == null) // Used for easy debugging an invalid AST
			throw new NullPointerException("Declaration on line " + declaration.getLine() + " does not have an identifer.");
		
		MemoryLocation ml = new MemoryLocation(declaration);
		memoryLocations.add(ml);
		
		currentBlock().push(new Instruction("PUSH","1","Declaring "+in.getNodeType()+" "+in.getText()));
	}
	
	public MemoryLocation allocHelperRegister()
	{
		currentBlock().push(new Instruction("PUSH","1","Pushing for helper register "));
		
		MemoryLocation ml = new MemoryLocation();
		memoryLocations.add(ml);
		
		return ml;
	}
	
	public String addressOfIdentifier(IdentifierNode node) throws GeneratorException
	{
		String result = null;
		int index = 0;
		
			for(MemoryLocation ml : memoryLocations)
			{
				DeclarationNode dc = ml.getDeclaration();
				
				if(dc != null && node.getDeclarationNode() == dc)
				{
					result = index + "[SB]";
				}
				
				index++;
			}
		
		if(result == null)
			throw new GeneratorException("MemoryLocation is not allocated");
		
		return result;

	}
	
	public String addressOfMemoryLocation(MemoryLocation ml) throws GeneratorException
	{
		String result = null;
		int index = 0;
		
		for(MemoryLocation mlr : memoryLocations)
		{
			if(mlr == ml) 
			{
				result = index + "[SB]";
			}
			
			index++;
		}
		
		if(result == null)
			throw new GeneratorException("MemoryLocation is not allocated");
		
		return result;
	}
	
	public InstructionBlock currentBlock() {
		return instructionBlockStack.peek();
	}

}
